local player = game.Players.LocalPlayer
local gui = player:WaitForChild("PlayerGui"):WaitForChild("Main")
local label = gui:WaitForChild("PvpDisabled")
local codes_button = gui:WaitForChild("Code")
local settings_button = gui:WaitForChild("HUDButtonBar")
local dmg_counter_button = settings_button:WaitForChild("Settings")
local script_enabled = "Скрипт включен успешно."
local notifier_enabled = "Уведомлятель включен успешно."
local notifier_disabled = "Уведомлятель выключен успешно."
local description = "Показывает локацию заспавненого фрукта."
local on = "Уведомлятель (ВКЛ)"
local off = "Уведомлятель (ВЫКЛ)"
local location = "ФРУКТ ЗАМЕЧЕН: "
local magnitude = "м осталось."
local collected = "Фрукт задеспавнился/собран."

local value = Instance.new("BoolValue")

-- if executed twice or more
if settings_button:FindFirstChild("NotifierLed") then
    return
end

label.Text = " "
label.Visible = true

-- creates led to indicate notifier status
dmg_counter_button:Clone().Parent = settings_button
dmg_counter_button.Name = "NotifierLed"
dmg_counter_button.Image = "http://www.roblox.com/asset/?id=14045555514"
dmg_counter_button.LocalScript:Destroy()
dmg_counter_button.Buttons:Destroy()

value.Parent = dmg_counter_button
value.Value = true
value.Name = "SwitchIs"

-- stores the connection, so after we can disconnect
-- on switch click (also used to check switch state)
local workspace_connection

-- displays text on the label that locates fruits
local function showText(text, time)
    label.Text = text
    label.Visible = true
    if (time ~= 0) then
        task.wait(time)
        label.Visible = false
    end
end

-- used when a fruit spawns
local function playSound(asset_id, pb_speed)
    local sound = Instance.new("Sound", workspace)
    sound.SoundId = asset_id
    sound.Volume = 1
    sound.PlaybackSpeed = pb_speed
    sound:Play()
    sound.Ended:Connect(function()
        sound:Destroy()
    end)
end

-- called when a fruit spawns
local function enableNotifier(fruit)
    local handle = fruit:WaitForChild("Handle")
    local fruit_alive = true
    playSound("rbxassetid://3997124966", 4)

    -- keeps updating the distance if fruit is alive and switch is on
    while fruit_alive and workspace_connection do
        local dist = math.floor((player.Character:WaitForChild("HumanoidRootPart").Position - handle.Position)
            .Magnitude * 0.15)
        showText(location .. dist .. magnitude, 0)
        task.wait(0.2)
        fruit_alive = workspace:FindFirstChild(fruit.Name)
    end

    if not fruit_alive then
        playSound("rbxassetid://4612375233", 1)
        showText(collected, 3)
    end
end

local function onSwitchClick()
    -- enables/disables workspace connection listening for children added
    --[[
    if enabledSwitch == true then
        workspace_connection:Disconnect() -- disconnect the event and stop listening
        workspace_connection = nil
        showText(notifier_disabled, 2)
    else
        showText(notifier_enabled, 2)

        -- connect event and starts listening
        workspace_connection = workspace.ChildAdded:Connect(function(child)
            if child.Name == "Fruit " then -- intended space
                task.spawn(enableNotifier, child)
            end
        end)
    end
    ]]
    if workspace_connection then          -- check if we are connected
        workspace_connection:Disconnect() -- disconnect the event and stop listening
        workspace_connection = nil
        showText(notifier_disabled, 2)
        value.Value = false
    else
        showText(notifier_enabled, 2)
        value.Value = true
        -- connect event and starts listening
        workspace_connection = workspace.ChildAdded:Connect(function(child)
            if child.Name == "Fruit " then -- intended space
                task.spawn(enableNotifier, child)
            end
        end)

-- looks for an already spawned fruit (need workspace_connection)
        local fruit = workspace:FindFirstChild("Fruit ") -- intended space
        if fruit then
            task.spawn(enableNotifier, fruit)
        end
    end
end

showText(script_enabled, 3)
onSwitchClick()
dmg_counter_button.Activated:Connect(onSwitchClick)

-- X
